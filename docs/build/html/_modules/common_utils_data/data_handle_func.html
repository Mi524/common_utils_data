<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>common_utils_data.data_handle_func &mdash; common_utils_data v0.9.1 文档</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/translations.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="搜索" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> common_utils_data
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="搜索文档" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="导航菜单">
              <!-- Local TOC -->
              <div class="local-toc"></div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="移动版导航菜单" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">common_utils_data</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="页面导航">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">模块代码</a></li>
      <li class="breadcrumb-item active">common_utils_data.data_handle_func</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>common_utils_data.data_handle_func 源代码</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">gc</span> 
<span class="kn">import</span> <span class="nn">re</span> 
<span class="kn">import</span> <span class="nn">sys</span>  
<span class="kn">import</span> <span class="nn">warnings</span> 
<span class="kn">import</span> <span class="nn">os</span> 
<span class="kn">import</span> <span class="nn">time</span>  
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span> 
<span class="kn">import</span> <span class="nn">warnings</span>   
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span><span class="p">,</span> <span class="n">Counter</span>

<span class="kn">from</span> <span class="nn">.sequence_functions</span> <span class="kn">import</span> <span class="n">list_diff_outer_join</span><span class="p">,</span> <span class="n">lcs</span><span class="p">,</span> <span class="n">filter_lcs</span>
<span class="kn">from</span> <span class="nn">.os_functions</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.df_functions</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.config_table</span> <span class="kn">import</span> <span class="n">ConfigReader</span> 
<span class="kn">from</span> <span class="nn">.excel_functions</span> <span class="kn">import</span> <span class="n">write_format_columns</span><span class="p">,</span> <span class="n">refresh_excel_calculations</span><span class="p">,</span> <span class="n">save_csv</span>
<span class="kn">from</span> <span class="nn">.regex_functions</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.decorator_functions</span> <span class="kn">import</span> <span class="o">*</span>

<div class="viewcode-block" id="replace_brackets2blank"><a class="viewcode-back" href="../../common_utils_data.html#common_utils_data.data_handle_func.replace_brackets2blank">[文档]</a><span class="k">def</span> <span class="nf">replace_brackets2blank</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="s1">&#39;()（）-_&#39;</span><span class="p">:</span>
        <span class="n">string</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">string</span> </div>

<span class="nd">@catch_and_print</span>
<span class="k">def</span> <span class="nf">check_mapping_complete</span><span class="p">(</span><span class="n">df_worksheet</span><span class="p">,</span> <span class="n">complete_header_df</span><span class="p">,</span> <span class="n">original2cn_dict</span><span class="p">,</span><span class="n">file_tag</span><span class="p">):</span>
    <span class="c1">#检查是否遗漏了不是“无”的映射字段`</span>
    <span class="n">c_required_columns</span> <span class="o">=</span> <span class="n">get_dict_unique_values</span><span class="p">(</span><span class="n">original2cn_dict</span><span class="p">)</span>
    <span class="n">check_required_columns</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">c_required_columns</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">df_worksheet</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="n">check_required_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">check_required_columns</span> \
                <span class="k">if</span> <span class="s1">&#39;fillbeforeconcat:&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;合并前填充:&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="p">]</span>

    <span class="k">if</span> <span class="n">check_required_columns</span><span class="p">:</span>
        <span class="n">warning_msg</span> <span class="o">=</span> <span class="s1">&#39;Warning: Failed to find the the mapping for column &#39;</span> \
                      <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">check_required_columns</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span> \
                      <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;of excel file tagging with &quot;</span><span class="si">{</span><span class="n">file_tag</span><span class="si">}</span><span class="s1">&quot;&#39;</span>

<span class="nd">@catch_and_print</span>
<span class="k">def</span> <span class="nf">dtype_handle</span><span class="p">(</span><span class="n">complete_header_df</span><span class="p">,</span> <span class="n">dtype_dict</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">dtype_dict</span><span class="p">:</span>
        <span class="c1">#转换成读取格式,主要处理日期有时读取成float格式的问题</span>
        <span class="k">for</span> <span class="n">dtype_column</span><span class="p">,</span> <span class="n">dtype_type</span> <span class="ow">in</span> <span class="n">dtype_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1">#处理输入数据的类型 日期类型--不包含时分秒 normalize().date 时间类型-包含时分秒-to_datetime, 和其他pandas支持的数据类型</span>
            <span class="n">dtype_type_temp</span> <span class="o">=</span> <span class="n">dtype_type</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">dtype_column</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">complete_header_df</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
                <span class="n">enter_exit</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Cannot find &quot;</span><span class="si">{</span><span class="n">dtype_column</span><span class="si">}</span><span class="s1">&quot; in concatnated_data!&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dtype_type_temp</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">or</span> <span class="n">dtype_type_temp</span> <span class="o">==</span> <span class="s1">&#39;默认&#39;</span> <span class="ow">or</span> <span class="n">dtype_type_temp</span> <span class="o">==</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span>
                <span class="k">pass</span> 
            <span class="k">elif</span> <span class="s1">&#39;date&#39;</span> <span class="ow">in</span> <span class="n">dtype_type_temp</span> <span class="ow">or</span> <span class="s1">&#39;time&#39;</span> <span class="ow">in</span> <span class="n">dtype_type_temp</span><span class="p">:</span>
                <span class="n">complete_header_df</span> <span class="o">=</span> <span class="n">normalize_dates</span><span class="p">(</span><span class="n">complete_header_df</span><span class="p">,</span> <span class="n">dtype_column</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;date&#39;</span> <span class="ow">in</span> <span class="n">dtype_type_temp</span><span class="p">:</span>  <span class="c1">#如果是只要日期，把它转成没有时分秒的格式</span>
                    <span class="n">complete_header_df</span><span class="p">[</span><span class="n">dtype_column</span><span class="p">]</span> <span class="o">=</span> <span class="n">complete_header_df</span><span class="p">[</span><span class="n">dtype_column</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">normalize</span><span class="p">()</span>
                    <span class="c1">#time 不用处理，前面已经normalize_date转成时间格式了</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1">#如果是日期，需要转成固定的2020/09/09的格式 提供给技术的java补录工具读取</span>
                <span class="k">if</span> <span class="n">output</span> <span class="ow">and</span> <span class="n">dtype_type_temp</span> <span class="o">==</span> <span class="s1">&#39;str&#39;</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">complete_header_df</span><span class="p">[</span><span class="n">dtype_column</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">):</span>
                    <span class="n">complete_header_df</span><span class="p">[</span><span class="n">dtype_column</span><span class="p">]</span> <span class="o">=</span> <span class="n">complete_header_df</span><span class="p">[</span><span class="n">dtype_column</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y/%m/</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1">#防止转成空值的float 类型变成 nan, 统一fillna</span>
                    <span class="k">try</span><span class="p">:</span>  <span class="c1">#防止有空值concat后全是float转str 其他非空的int也会带个小数点</span>
                        <span class="n">complete_header_df</span><span class="p">[</span><span class="n">dtype_column</span><span class="p">]</span> <span class="o">=</span> <span class="n">complete_header_df</span><span class="p">[</span><span class="n">dtype_column</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>\
                        <span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype_type</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;.0&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;.0&#39;</span> <span class="k">else</span> <span class="n">x</span> <span class="p">)</span>
                    <span class="k">except</span> <span class="p">:</span>
                        <span class="n">enter_exit</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Failed to convert column &quot;</span><span class="si">{</span><span class="n">dtype_column</span><span class="si">}</span><span class="s1">&quot; to dtype &quot;</span><span class="si">{</span><span class="n">dtype_type</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">complete_header_df</span>

<span class="nd">@catch_and_print</span>
<span class="k">def</span> <span class="nf">get_dict_unique_values</span><span class="p">(</span> <span class="n">dictionary</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;提取一个字典里面的所有非重复的values作为key构建新的字典，新字典values统一为1&quot;&quot;&quot;</span>
    <span class="n">record_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dictionary</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">record_set</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">record_set</span>

<span class="nd">@catch_and_print</span>
<span class="k">def</span> <span class="nf">combine_multi_plus</span><span class="p">(</span><span class="n">df_worksheet</span><span class="p">,</span><span class="n">original2cn_dict</span><span class="p">):</span>
    <span class="c1">#加入系统表格处理,联系方式合并Tel,Email,Facebook</span>
    <span class="n">multi_plus_list</span> <span class="o">=</span>  <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">original2cn_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="s1">&#39;+&#39;</span> <span class="ow">in</span> <span class="n">x</span> <span class="p">]</span>
    <span class="k">if</span> <span class="n">multi_plus_list</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">multi_plus_list</span><span class="p">:</span>
            <span class="n">m_split_list</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="p">)</span>
            <span class="n">find_lack_columns</span><span class="p">(</span><span class="n">df_worksheet</span><span class="p">,</span> <span class="n">m_split_list</span><span class="p">,</span><span class="s1">&#39;combine_multi_plus&#39;</span><span class="p">)</span>
            <span class="n">df_worksheet</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_worksheet</span><span class="p">[</span><span class="n">m_split_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> 
            <span class="k">for</span> <span class="n">m_s</span> <span class="ow">in</span> <span class="n">m_split_list</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="n">df_worksheet</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_worksheet</span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>\
                                  <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">df_worksheet</span><span class="p">[</span><span class="n">m_s</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">df_worksheet</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_worksheet</span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">df_worksheet</span>


<span class="nd">@catch_and_print</span>
<span class="k">def</span> <span class="nf">get_filter_condition_match</span><span class="p">(</span><span class="n">join_table_df</span><span class="p">,</span> <span class="n">filter_condition</span><span class="p">):</span>
    <span class="c1">#匹配的字段条件和模糊匹配(字段标准化)不同</span>
      
    <span class="k">if</span> <span class="n">filter_condition</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="p">:</span>
        <span class="n">join_table_df</span> <span class="o">=</span> <span class="n">df_query</span><span class="p">(</span><span class="n">join_table_df</span><span class="p">,</span><span class="n">filter_condition</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">join_table_df</span> 

<span class="nd">@catch_and_print</span>
<span class="k">def</span> <span class="nf">is_df_column</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
    <span class="k">return</span> <span class="s1">&#39;[&#39;</span> <span class="o">==</span> <span class="n">string</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;]&#39;</span> <span class="o">==</span> <span class="n">string</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> 

<span class="nd">@catch_and_print</span>
<span class="k">def</span> <span class="nf">get_filter_condition_standardize_tag</span><span class="p">(</span><span class="n">filter_condition</span><span class="p">):</span>
    <span class="c1">#仅限于模糊匹配，里面可能会填入 [国家/地区 == 国家/地区] 的形式</span>
    <span class="c1">#代表是否填入的两个表的相同或不同字段</span>
    <span class="n">filter_condition_2_columns_tag</span> <span class="o">=</span> <span class="kc">False</span> 
    <span class="n">filter_left_column</span><span class="p">,</span> <span class="n">filter_right_column</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="n">is_df_column</span><span class="p">(</span><span class="n">filter_condition</span><span class="p">)</span> <span class="p">:</span> 
        <span class="n">filter_condition_2_columns_tag</span> <span class="o">=</span> <span class="kc">True</span> 

        <span class="n">filter_condition</span> <span class="o">=</span> <span class="n">filter_condition</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">)</span>
        <span class="n">filter_condition_list</span> <span class="o">=</span> <span class="p">[</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">filter_condition</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;==&#39;</span><span class="p">)</span> <span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filter_condition_list</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="p">:</span>
            <span class="n">enter_exit</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Standardization:failed to compile filter condition:</span><span class="si">{</span><span class="n">filter_condition</span><span class="si">}</span><span class="s1">!&#39;</span><span class="p">)</span> 
        <span class="k">else</span><span class="p">:</span>
            <span class="n">filter_left_column</span> <span class="o">=</span> <span class="n">filter_condition_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">filter_right_column</span> <span class="o">=</span> <span class="n">filter_condition_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> 

    <span class="k">return</span> <span class="n">filter_condition_2_columns_tag</span><span class="p">,</span> <span class="n">filter_left_column</span><span class="p">,</span> <span class="n">filter_right_column</span>

<span class="nd">@catch_and_print</span>
<span class="k">def</span> <span class="nf">process_sort_order</span><span class="p">(</span><span class="n">join_table_df</span><span class="p">,</span> <span class="n">join_columns</span><span class="p">,</span> <span class="n">string</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">string</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="p">:</span>
        <span class="n">order_columns</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
        <span class="n">reverse_order</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>

        <span class="n">reverse_order</span> <span class="o">=</span> <span class="p">[</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;desc&#39;</span> <span class="k">else</span> <span class="kc">False</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">reverse_order</span> <span class="p">]</span>

        <span class="n">order_columns_new</span> <span class="o">=</span> <span class="p">[</span> <span class="p">]</span>
        <span class="n">reverse_ordere_new</span> <span class="o">=</span> <span class="p">[</span> <span class="p">]</span>
        <span class="k">for</span> <span class="n">sort</span><span class="p">,</span> <span class="n">order</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">order_columns</span><span class="p">,</span> <span class="n">reverse_order</span><span class="p">)</span> <span class="p">:</span>
            <span class="c1">#join_columns是用来确保 匹配前的on字段也有参与排序，并且不会和人工填入的字段出现重复</span>
            <span class="k">if</span> <span class="n">sort</span> <span class="ow">in</span> <span class="n">join_table_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">sort</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">join_columns</span> <span class="p">:</span>
                    <span class="n">order_columns_new</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sort</span><span class="p">)</span>
                    <span class="n">reverse_ordere_new</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Match table cannot find column &quot;</span><span class="si">{</span><span class="n">sort</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>

        <span class="n">order_columns_new</span> <span class="o">=</span> <span class="n">join_columns</span> <span class="o">+</span> <span class="n">order_columns_new</span>
        <span class="n">reverse_ordere_new</span> <span class="o">=</span> <span class="p">[</span> <span class="kc">True</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">join_columns</span><span class="p">))</span> <span class="p">]</span>  <span class="o">+</span> <span class="n">reverse_ordere_new</span>

        <span class="n">join_table_df</span> <span class="o">=</span> <span class="n">join_table_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">order_columns_new</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="n">reverse_ordere_new</span> <span class="p">)</span>

        <span class="n">join_table_df</span> <span class="o">=</span> <span class="n">join_table_df</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">join_table_df</span>

<span class="nd">@catch_and_print</span>
<span class="k">def</span> <span class="nf">calc_similarity</span><span class="p">(</span><span class="n">not_standard_str</span><span class="p">,</span> <span class="n">new_standard_str</span><span class="p">,</span><span class="n">calc_func</span> <span class="p">):</span>

    <span class="c1">#先把括号换成空格</span>
    <span class="n">not_standard_str</span> <span class="o">=</span> <span class="n">replace_brackets2blank</span><span class="p">(</span><span class="n">not_standard_str</span><span class="p">)</span>
    <span class="n">new_standard_str</span> <span class="o">=</span> <span class="n">replace_brackets2blank</span><span class="p">(</span><span class="n">new_standard_str</span><span class="p">)</span>

    <span class="n">str_similarity</span> <span class="o">=</span> <span class="mi">0</span> 

    <span class="n">match_list</span> <span class="o">=</span> <span class="n">calc_func</span><span class="p">(</span><span class="n">not_standard_str</span><span class="p">,</span> <span class="n">new_standard_str</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
    <span class="c1">#如果这里就发现一个都没有发现匹配到，直接填相似度为0</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">match_list</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">str_similarity</span>

    <span class="c1">#未处理符号的连续字母命中最多的优先,&#39;PD1945F/FF/CF/DF/EF&#39;， &#39;PD1945BF/DF/FF_EX&#39; PD1945F  应该优先选第一个，第二个只是长度短而已</span>
    <span class="n">continues_match</span> <span class="o">=</span> <span class="mi">0</span> 
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">not_standard_str</span><span class="p">)):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">not_standard_str</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">new_standard_str</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="n">continues_match</span> <span class="o">+=</span> <span class="mi">1</span> 
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">break</span>

    <span class="c1">#解决上面有些因为内存而导致匹配到的字符长，但却匹配错的问题</span>
    <span class="n">not_standard_str_no_space</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">not_standard_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">new_standard_str_no_space</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new_standard_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="c1">#用分母的方式，解决 Y15 优先 配到了 Y15S 而不是 Y15(4+64G)的问题</span>
    <span class="n">match_list_no_space</span> <span class="o">=</span> <span class="n">calc_func</span><span class="p">(</span><span class="n">not_standard_str_no_space</span><span class="p">,</span> <span class="n">new_standard_str_no_space</span> <span class="p">)</span>
    
    <span class="n">match_list_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">match_list</span><span class="p">)</span>
    <span class="n">match_list_len_no_space</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">match_list_no_space</span><span class="p">)</span> 


    <span class="k">try</span><span class="p">:</span> <span class="c1">#也门 -- 对应被拆开的 卡塔尔 也门 科威特 阿曼,第一个卡塔尔拆出来之后 分母为0 </span>
        <span class="n">match_list_len_no_space_divide</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">not_standard_str_no_space</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_standard_str_no_space</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ZeroDivisionError</span><span class="p">:</span>
        <span class="n">match_list_len_no_space_divide</span> <span class="o">=</span> <span class="mi">0</span> 

    <span class="n">str_similarity</span> <span class="o">=</span> <span class="n">match_list_len</span> <span class="o">+</span> <span class="n">continues_match</span> <span class="o">+</span> <span class="n">match_list_len_no_space</span> <span class="o">+</span> <span class="n">match_list_len_no_space_divide</span>

    <span class="k">return</span> <span class="n">str_similarity</span>

<span class="nd">@catch_and_print</span>
<span class="k">def</span> <span class="nf">replace_by_dict</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">replace_dict</span><span class="o">=</span><span class="p">{}):</span>
    <span class="k">if</span> <span class="n">replace_dict</span> <span class="p">:</span>    
        <span class="c1">#先做替换</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">replace_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">string</span><span class="p">,</span> <span class="n">sub_num</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">subn</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">string</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>
            <span class="c1">#如果已经替换成功就停止，不往下替换</span>
            <span class="k">if</span> <span class="n">sub_num</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">:</span>
                <span class="k">break</span>
    <span class="k">return</span> <span class="n">string</span> 

<span class="nd">@catch_and_print</span>
<span class="k">def</span> <span class="nf">check_similarity_number</span><span class="p">(</span> <span class="n">not_standard_str</span><span class="p">,</span> <span class="n">standard_dict</span><span class="p">,</span><span class="n">special_syn_list</span><span class="p">,</span>
                             <span class="n">ignore_punctuation</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

    <span class="c1">#某些情况不符合模糊匹配条件默认加入的结果 </span>
    <span class="n">not_match_default</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">]</span>

    <span class="n">first_syn</span> <span class="o">=</span> <span class="p">[</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">special_syn_list</span> <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">standard_str</span><span class="p">,</span> <span class="n">target_str</span> <span class="ow">in</span> <span class="n">standard_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1">#创建一个专门用来匹配的新standard_str</span>
        <span class="n">new_standard_str</span> <span class="o">=</span> <span class="n">standard_str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="c1">#和其他两个匹配方式有区别，忽略掉ignore_punctuation为了保证regex的结果</span>
        <span class="k">if</span> <span class="n">special_syn_list</span><span class="p">:</span>
            <span class="n">syn_checking</span> <span class="o">=</span> <span class="n">check_syn_str_regex_number</span><span class="p">(</span><span class="n">not_standard_str</span><span class="p">,</span><span class="n">new_standard_str</span><span class="p">,</span><span class="n">special_syn_list</span><span class="p">)</span>
            <span class="c1">#如果检查两边两边的同步字符不同, 直接判断为不符合</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">syn_checking</span><span class="p">:</span>
                <span class="k">continue</span> 
        <span class="c1">#需要填入ram_rom 获取到的部分 才能对内存数字是否相同做到完美的判断, 不放入first_syn会导致 (y3 16G+128)可能会匹配到(3+16G)</span>
        <span class="n">match_list</span> <span class="o">=</span> <span class="n">number_similarity</span><span class="p">(</span><span class="n">not_standard_str</span><span class="p">,</span><span class="n">new_standard_str</span><span class="p">,</span> <span class="n">first_syn</span><span class="p">)</span>

        <span class="c1">#以下可以直接用是否返回match_list来判断</span>
        <span class="k">if</span> <span class="n">match_list</span> <span class="p">:</span>
            <span class="k">return</span> <span class="p">[[</span><span class="mi">99</span><span class="p">,</span> <span class="n">new_standard_str</span><span class="p">,</span> <span class="n">target_str</span><span class="p">]]</span>

    <span class="k">return</span> <span class="p">[</span> <span class="n">not_match_default</span> <span class="p">]</span>

<span class="nd">@catch_and_print</span>  
<span class="k">def</span> <span class="nf">compare_number_part</span><span class="p">(</span><span class="n">string1</span><span class="p">,</span> <span class="n">string2</span><span class="p">):</span>
    <span class="n">not_standard_number</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">new_standard_number</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span> 
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">string1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
            <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span> 
            <span class="n">not_standard_number</span> <span class="o">+=</span> <span class="n">s</span> 
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">counter</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="p">:</span> 
                <span class="k">break</span> 
    <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span> 
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">string2</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
            <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span> 
            <span class="n">new_standard_number</span> <span class="o">+=</span> <span class="n">s</span> 
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">counter</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="p">:</span>
                <span class="k">break</span>

    <span class="k">return</span> <span class="n">not_standard_number</span> <span class="o">==</span>  <span class="n">new_standard_number</span>

<span class="nd">@catch_and_print</span>
<span class="k">def</span> <span class="nf">check_similarity_simple</span><span class="p">(</span> <span class="n">not_standard_str</span><span class="p">,</span> <span class="n">standard_dict</span><span class="p">,</span><span class="n">special_syn_list</span><span class="p">,</span>
                             <span class="n">ignore_punctuation</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    1. 完全相等直接返回</span>
<span class="sd">    2. 需要两边同时有special_syn_list, 同时ignore_punctuation</span>
<span class="sd">    3. 相同的字符至少要有两个及以上</span>
<span class="sd">    4. 从遇到第一个数字开始连续的数字部分（第一个数字部分）必须相同, PD1945不能因为没有别的相似而配上PD1948</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#not_standard_str不要填入空字符串防止运行累赘,在前面的函数做判断</span>
    <span class="n">standard_similarity_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1">#某些情况不符合模糊匹配条件默认加入的结果 </span>
    <span class="n">not_match_default</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">standard_str</span><span class="p">,</span> <span class="n">target_str</span> <span class="ow">in</span> <span class="n">standard_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1">#创建一个专门用来匹配的新standard_str</span>
        <span class="n">new_standard_str</span> <span class="o">=</span> <span class="n">standard_str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
       <span class="c1">#确认至少两个字符相同，并且如果出现数字，从左往右遇到第一个完整连续的数字串，必须完全相同</span>
        <span class="n">check_number_part</span> <span class="o">=</span> <span class="n">compare_number_part</span><span class="p">(</span><span class="n">not_standard_str</span><span class="p">,</span> <span class="n">new_standard_str</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">check_number_part</span><span class="p">:</span>
            <span class="n">standard_similarity_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">not_match_default</span><span class="p">)</span>
            <span class="k">continue</span>  

        <span class="c1">#如果完全相等直接,不往下面走, 直接返回</span>
        <span class="k">if</span> <span class="n">not_standard_str</span> <span class="o">==</span> <span class="n">new_standard_str</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[[</span><span class="mi">99</span><span class="p">,</span> <span class="n">standard_str</span><span class="p">,</span> <span class="n">target_str</span><span class="p">]]</span>

        <span class="k">if</span> <span class="n">ignore_punctuation</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">new_standard_str</span> <span class="o">=</span> <span class="n">replace_punctuations</span><span class="p">(</span><span class="n">new_standard_str</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">special_syn_list</span><span class="p">:</span>
            <span class="n">syn_checking</span> <span class="o">=</span> <span class="n">check_syn_str_regex</span><span class="p">(</span><span class="n">not_standard_str</span><span class="p">,</span><span class="n">new_standard_str</span><span class="p">,</span><span class="n">special_syn_list</span><span class="p">)</span>
            <span class="c1">#如果检查两边两边的同步字符不同, 直接返回判断为</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">syn_checking</span><span class="p">:</span>
                <span class="n">standard_similarity_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">not_match_default</span><span class="p">)</span>
                <span class="k">continue</span>

        <span class="n">str_similarity</span> <span class="o">=</span> <span class="n">calc_similarity</span><span class="p">(</span><span class="n">not_standard_str</span><span class="p">,</span> <span class="n">new_standard_str</span><span class="p">,</span> <span class="n">lcs</span> <span class="p">)</span>

        <span class="c1">#上面一截 除了lcs函数不同，其他都一样</span>
        <span class="k">if</span> <span class="n">str_similarity</span> <span class="o">&gt;=</span><span class="mi">2</span>  <span class="p">:</span>
            <span class="n">standard_similarity_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">str_similarity</span><span class="p">,</span> <span class="n">standard_str</span><span class="p">,</span> <span class="n">target_str</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">standard_similarity_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">not_match_default</span><span class="p">)</span>

    <span class="n">standard_similarity_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">standard_similarity_list</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">reverse</span> <span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">standard_similarity_list</span>

<span class="nd">@catch_and_print</span>
<span class="k">def</span> <span class="nf">check_similarity_strict</span><span class="p">(</span> <span class="n">not_standard_str</span><span class="p">,</span> <span class="n">standard_dict</span><span class="p">,</span><span class="n">special_syn_list</span><span class="p">,</span>
                             <span class="n">replace_dict</span><span class="o">=</span><span class="p">{},</span> <span class="n">ignore_punctuation</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="c1">#not_standard_str不要填入空字符串防止运行累赘</span>
     <span class="c1">#机型匹配模式，用的是filter_lcs,因为要确保前面2个或3个字母都相同</span>
    <span class="n">standard_similarity_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1">#某些情况不符合模糊匹配条件默认加入的结果 </span>
    <span class="n">not_match_default</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">standard_str</span><span class="p">,</span> <span class="n">target_str</span> <span class="ow">in</span> <span class="n">standard_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1">#创建一个专门用来匹配的新standard_str</span>
        <span class="n">new_standard_str</span> <span class="o">=</span> <span class="n">standard_str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="c1">#如果完全相等直接,不往下面走, 直接返回</span>
        <span class="k">if</span> <span class="n">not_standard_str</span> <span class="o">==</span> <span class="n">new_standard_str</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[[</span><span class="mi">99</span><span class="p">,</span> <span class="n">standard_str</span><span class="p">,</span> <span class="n">target_str</span><span class="p">]]</span>

        <span class="k">if</span> <span class="n">ignore_punctuation</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">new_standard_str</span> <span class="o">=</span> <span class="n">replace_punctuations</span><span class="p">(</span><span class="n">new_standard_str</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">special_syn_list</span><span class="p">:</span>
            <span class="n">syn_checking</span> <span class="o">=</span> <span class="n">check_syn_str_regex</span><span class="p">(</span><span class="n">not_standard_str</span><span class="p">,</span><span class="n">new_standard_str</span><span class="p">,</span><span class="n">special_syn_list</span><span class="p">)</span>
            <span class="c1">#如果检查两边两边的同步字符不同, 直接返回判断为</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">syn_checking</span><span class="p">:</span>
                <span class="n">standard_similarity_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">not_match_default</span><span class="p">)</span>
                <span class="k">continue</span>

        <span class="n">str_similarity</span> <span class="o">=</span> <span class="n">calc_similarity</span><span class="p">(</span><span class="n">not_standard_str</span><span class="p">,</span> <span class="n">new_standard_str</span><span class="p">,</span><span class="n">filter_lcs</span> <span class="p">)</span>

        <span class="k">if</span> <span class="n">str_similarity</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="p">:</span> 
            <span class="c1"># 有3个和3个以上的字符，前3个全是字母确保3个字母都相同，前3个字符有数字和英文，确保英文和数字都相同</span>
            <span class="c1"># 前两/三位字母相同,方便后面elif写条件</span>
            <span class="n">first2_letter_equal</span> <span class="o">=</span> <span class="n">not_standard_str</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">new_standard_str</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][:</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">first3_letter_equal</span> <span class="o">=</span> <span class="n">not_standard_str</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">new_standard_str</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][:</span><span class="mi">3</span><span class="p">]</span>

            <span class="c1">#前3位字符串包含2个数字的情况 必须满足前3个字母相同</span>
            <span class="n">first3_letter_2num_not_standard</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;[0-9]{2,}&#39;</span><span class="p">,</span><span class="n">not_standard_str</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span> <span class="o">!=</span> <span class="kc">None</span>
            <span class="n">first3_letter_2num_standard</span> <span class="o">=</span>  <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;[0-9]{2,}&#39;</span><span class="p">,</span><span class="n">new_standard_str</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span> <span class="o">!=</span> <span class="kc">None</span>

            <span class="n">first3_letter_less2num_not_standard</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">first3_letter_2num_not_standard</span>
            <span class="n">first3_letter_less2num_standard</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">first3_letter_2num_standard</span>

            <span class="c1">#1. 如果输入机型只有2个字符，空格分割开的字符必须完全相同: 因为V1不能配成V11</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">not_standard_str</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="p">:</span>
                <span class="n">new_standard_str</span> <span class="o">=</span> <span class="n">new_standard_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">not_standard_str</span> <span class="o">==</span> <span class="n">new_standard_str</span><span class="p">:</span>
                    <span class="n">standard_similarity_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">str_similarity</span><span class="p">,</span> <span class="n">standard_str</span><span class="p">,</span> <span class="n">target_str</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">standard_similarity_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">not_match_default</span><span class="p">)</span>

            <span class="k">elif</span>   <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">not_standard_str</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">first2_letter_equal</span><span class="p">)</span> <span class="ow">and</span> \
             <span class="p">(</span>     <span class="c1">#输入字符 前3位有2个数字 + 标准字符 前3位也有2个数字 -- &gt; 前3个必须要相等</span>
                   <span class="p">(</span><span class="n">first3_letter_2num_not_standard</span> <span class="ow">and</span> <span class="n">first3_letter_2num_standard</span> <span class="ow">and</span> <span class="n">first3_letter_equal</span><span class="p">)</span> \
                   <span class="c1">#输入字符 前3位没有2个数字 + 标准字符 前3位也没有2个数字 -- &gt; 前2个字符必须要相等</span>
                <span class="ow">or</span> <span class="p">(</span><span class="n">first3_letter_less2num_not_standard</span> <span class="ow">and</span> <span class="n">first3_letter_less2num_standard</span> <span class="ow">and</span> <span class="n">first2_letter_equal</span><span class="p">)</span>
             <span class="p">):</span>
                <span class="n">standard_similarity_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">str_similarity</span><span class="p">,</span> <span class="n">standard_str</span><span class="p">,</span><span class="n">target_str</span><span class="p">])</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="n">standard_similarity_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">not_match_default</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">standard_similarity_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">not_match_default</span><span class="p">)</span>

    <span class="n">standard_similarity_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">standard_similarity_list</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">reverse</span> <span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">standard_similarity_list</span>

<span class="nd">@catch_and_print</span>
<span class="k">def</span> <span class="nf">standardize_by_similarity</span><span class="p">(</span> <span class="n">not_standard_str</span><span class="p">,</span> <span class="n">standard_dict</span><span class="p">,</span> <span class="n">special_syn_list</span><span class="p">,</span>
                               <span class="n">replace_dict</span><span class="o">=</span><span class="p">{},</span>  <span class="n">mode</span> <span class="o">=</span><span class="s1">&#39;filter_lcs&#39;</span><span class="p">,</span><span class="n">ignore_punctuation</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="c1">#mode, simple_lcs --用来匹配简单的国家 or filter_lcs -- 用来匹配机型</span>
    <span class="c1">#替换干扰符号和干扰词</span>
    <span class="c1">#处理中文国家缩写和完整国家名称无法匹配到的情况</span>

    <span class="c1">#前面已经做过去重</span>
    <span class="n">not_standard_str</span> <span class="o">=</span> <span class="n">replace_by_dict</span><span class="p">(</span><span class="n">not_standard_str</span><span class="p">,</span> <span class="n">replace_dict</span><span class="p">)</span>

    <span class="n">not_standard_str</span> <span class="o">=</span> <span class="n">not_standard_str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="n">standard_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">standard_dict</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">reverse</span><span class="o">=</span> <span class="kc">False</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;simple_lcs&#39;</span><span class="p">:</span>
        <span class="n">standard_similarity_list</span> <span class="o">=</span> <span class="n">check_similarity_simple</span><span class="p">(</span><span class="n">not_standard_str</span><span class="p">,</span> <span class="n">standard_dict</span><span class="p">,</span><span class="n">special_syn_list</span><span class="p">,</span>
                                                            <span class="n">ignore_punctuation</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;number_similarity&#39;</span><span class="p">:</span>
        <span class="n">standard_similarity_list</span> <span class="o">=</span> <span class="n">check_similarity_number</span><span class="p">(</span><span class="n">not_standard_str</span><span class="p">,</span> <span class="n">standard_dict</span><span class="p">,</span><span class="n">special_syn_list</span><span class="p">,</span>
                                                            <span class="n">ignore_punctuation</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">standard_similarity_list</span> <span class="o">=</span> <span class="n">check_similarity_strict</span><span class="p">(</span><span class="n">not_standard_str</span><span class="p">,</span> <span class="n">standard_dict</span><span class="p">,</span><span class="n">special_syn_list</span><span class="p">,</span>
                                                            <span class="n">ignore_punctuation</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">standard_similarity_list</span>

<span class="nd">@catch_and_print</span>
<span class="k">def</span> <span class="nf">standardize_column_func</span><span class="p">(</span> <span class="n">not_standard_str</span><span class="p">,</span> <span class="n">standard_dict</span><span class="p">,</span> <span class="n">special_syn_list</span><span class="p">,</span>
                             <span class="n">replace_dict</span><span class="o">=</span><span class="p">{},</span> <span class="n">mode</span> <span class="o">=</span><span class="s1">&#39;filter_lcs&#39;</span><span class="p">,</span> <span class="n">ignore_punctuation</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

    <span class="n">standard_similarity_list</span> <span class="o">=</span> <span class="n">standardize_by_similarity</span><span class="p">(</span><span class="n">not_standard_str</span><span class="p">,</span> <span class="n">standard_dict</span><span class="p">,</span> <span class="n">special_syn_list</span><span class="p">,</span>
                                                         <span class="n">replace_dict</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span><span class="n">ignore_punctuation</span><span class="p">)</span>

    <span class="c1">#确保输入的不为空</span>
    <span class="k">if</span> <span class="n">not_standard_str</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">not_standard_str</span> <span class="o">==</span>  <span class="n">not_standard_str</span> <span class="p">:</span>
        <span class="k">if</span> <span class="n">standard_similarity_list</span> <span class="ow">and</span> <span class="n">standard_similarity_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">:</span>
            <span class="k">return</span> <span class="n">standard_similarity_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;&#39;</span>
    
    <span class="k">return</span> <span class="s1">&#39;&#39;</span>

<span class="nd">@catch_and_print</span>
<span class="k">def</span> <span class="nf">dropping_not_mapping</span><span class="p">(</span><span class="n">df_worksheet</span><span class="p">,</span> <span class="n">original2cn_dict</span><span class="p">,</span> <span class="n">target_cn_columns</span><span class="p">):</span>
    <span class="n">mapping_column_list</span> <span class="o">=</span> <span class="p">[</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span>  <span class="n">original2cn_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
    <span class="c1">#如果现有的字段和需要的target字段有重复，但其实并不想映射进目的字段（因为可能数据是不同含义），先要删掉原始表的重复字段</span>
    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">df_worksheet</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span> 
        <span class="k">if</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">target_cn_columns</span> <span class="ow">and</span> <span class="n">d</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mapping_column_list</span><span class="p">:</span>
            <span class="n">df_worksheet</span> <span class="o">=</span> <span class="n">df_worksheet</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> 
    <span class="k">return</span> <span class="n">df_worksheet</span>

<span class="nd">@catch_and_print</span>
<span class="k">def</span> <span class="nf">read_csv_data</span><span class="p">(</span><span class="n">table_path</span><span class="p">):</span>
    <span class="n">df_worksheet</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([])</span>
    <span class="k">for</span> <span class="n">encoding</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span><span class="s1">&#39;gbk&#39;</span><span class="p">,</span><span class="s1">&#39;gb2312&#39;</span><span class="p">]</span> <span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">df_worksheet</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">table_path</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span> <span class="p">)</span>
            <span class="k">break</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;***** Failed to read file:</span><span class="si">{</span><span class="n">table_path</span><span class="si">}</span><span class="s1"> with encoding: </span><span class="si">{</span><span class="n">encoding</span><span class="si">}</span><span class="s1"> ***** &#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">continue</span>
    <span class="k">if</span> <span class="n">df_worksheet</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;***** Failed to read file:</span><span class="si">{</span><span class="n">table_path</span><span class="si">}</span><span class="s1"> *****&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df_worksheet</span>

<span class="nd">@catch_and_print</span>
<span class="k">def</span> <span class="nf">read_xls_special</span><span class="p">(</span><span class="n">table_path</span><span class="p">):</span>
    <span class="n">df_worksheet</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([])</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">df_worksheet</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_html</span><span class="p">(</span><span class="n">table_path</span><span class="p">,</span><span class="n">header</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;***** Failed to read file:</span><span class="si">{</span><span class="n">table_path</span><span class="si">}</span><span class="s1"> ***** &#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df_worksheet</span> 

<span class="nd">@catch_and_print</span>
<span class="k">def</span> <span class="nf">get_min_max_date</span><span class="p">(</span><span class="n">result_df</span> <span class="p">):</span>
    <span class="n">min_max_date_range</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">date_time_df</span> <span class="o">=</span> <span class="n">result_df</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">])</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">date_time_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="n">datetime_series</span> <span class="o">=</span> <span class="n">date_time_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1">#报错的情况：所有值都是nan  [&#39;NaT&#39; &#39;NaT&#39; &#39;NaT&#39; ... &#39;NaT&#39; &#39;NaT&#39; &#39;NaT&#39;]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">min_datetime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">datetime_series</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="s1">&#39;%Y.%m.</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">max_datetime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">datetime_series</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="s1">&#39;%Y.%m.</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">min_max_date_range</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">min_datetime</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">max_datetime</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="k">return</span> <span class="n">min_max_date_range</span>

<span class="nd">@catch_and_print</span>
<span class="k">def</span> <span class="nf">drop_duplicated_columns_before_rename</span><span class="p">(</span><span class="n">df_worksheet</span><span class="p">,</span> <span class="n">original2cn_dict</span><span class="p">):</span>
    <span class="n">original_columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df_worksheet</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

    <span class="n">duplicated_columns</span> <span class="o">=</span> <span class="p">[</span> <span class="p">]</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">original2cn_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">original_columns</span><span class="p">:</span>
            <span class="n">duplicated_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

    <span class="n">df_worksheet</span> <span class="o">=</span> <span class="n">df_worksheet</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">duplicated_columns</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df_worksheet</span>

<span class="nd">@catch_and_print</span>
<span class="k">def</span> <span class="nf">refresh_configs</span><span class="p">(</span><span class="n">config_table_path_list</span><span class="p">):</span>
    <span class="c1">#读取配置前，是否刷新一遍文档内的公式并保存，注意这里不能打开配置文件，否则会无法保存成功</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">config_table_path_list</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Refreshing excel:</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">refresh_excel_calculations</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

<span class="nd">@catch_and_print</span>
<span class="k">def</span> <span class="nf">get_standard_mode</span><span class="p">(</span><span class="n">standardize_mode</span><span class="p">):</span>
    <span class="k">if</span> <span class="s1">&#39;number&#39;</span> <span class="ow">in</span> <span class="n">standardize_mode</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;number_similarity&#39;</span>
    <span class="k">elif</span> <span class="s1">&#39;simple&#39;</span> <span class="ow">in</span> <span class="n">standardize_mode</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;simple_lcs&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;filter_lcs&#39;</span>
    <span class="k">return</span> <span class="n">mode</span> 

<span class="nd">@catch_and_print</span>
<span class="k">def</span> <span class="nf">get_partial_not_match</span><span class="p">(</span><span class="n">complete_header_df_notna</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span><span class="n">source_column</span><span class="p">,</span> 
                            <span class="n">standard_table_name</span><span class="p">,</span> <span class="n">standard_column</span><span class="p">,</span> 
                           <span class="n">filter_condition</span><span class="p">,</span> <span class="n">target_column_edit</span><span class="p">,</span> <span class="n">filter_left_column</span><span class="p">):</span>

    <span class="n">column_order</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Standization No.&#39;</span><span class="p">,</span><span class="s1">&#39;Source_column&#39;</span><span class="p">,</span> <span class="s1">&#39;Standard_column&#39;</span><span class="p">,</span> <span class="s1">&#39;Content needs to standardized&#39;</span><span class="p">,</span> <span class="s1">&#39;Filter condition&#39;</span><span class="p">,</span><span class="s1">&#39;Filter content&#39;</span><span class="p">]</span>

    <span class="n">stand_column</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">standard_table_name</span><span class="p">,</span><span class="n">standard_column</span><span class="p">])</span>

    <span class="c1">#获取模糊匹配(标准化)失败的部分</span>
    <span class="n">find_lack_columns</span><span class="p">(</span><span class="n">complete_header_df_notna</span><span class="p">,</span> <span class="p">[</span><span class="n">target_column_edit</span><span class="p">,</span> <span class="n">source_column</span><span class="p">])</span>

    <span class="n">temp_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">source_column</span> <span class="p">]</span>
    <span class="n">temp_headers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Content needs to standardized&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">filter_left_column</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">temp_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filter_left_column</span><span class="p">)</span>
        <span class="n">temp_headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Filter content&#39;</span><span class="p">)</span>

    <span class="n">partial_match_not_match_df</span> <span class="o">=</span> <span class="n">complete_header_df_notna</span>\
            <span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">complete_header_df_notna</span><span class="p">[</span><span class="n">target_column_edit</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">==</span><span class="kc">True</span><span class="p">)</span>\
            <span class="o">|</span><span class="p">(</span><span class="n">complete_header_df_notna</span><span class="p">[</span><span class="n">target_column_edit</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="n">temp_columns</span> <span class="p">]</span> 

    <span class="k">if</span> <span class="ow">not</span> <span class="n">partial_match_not_match_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="c1">#获取到的原始列内容</span>
        <span class="n">partial_match_not_match_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">temp_headers</span>

        <span class="n">partial_match_not_match_df</span><span class="p">[</span><span class="s1">&#39;Source_column&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">source_column</span>
        <span class="n">partial_match_not_match_df</span><span class="p">[</span><span class="s1">&#39;Standard_column&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stand_column</span>
        <span class="n">partial_match_not_match_df</span><span class="p">[</span><span class="s1">&#39;Filter condition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">filter_condition</span>

        <span class="n">partial_match_not_match_df</span><span class="p">[</span><span class="s1">&#39;Standization No.&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">seq</span>

    <span class="n">partial_match_not_match_df</span> <span class="o">=</span> <span class="n">func_loc</span><span class="p">(</span><span class="n">partial_match_not_match_df</span><span class="p">,</span> <span class="n">column_order</span><span class="p">)</span> 

    <span class="n">partial_match_not_match_df</span> <span class="o">=</span> <span class="n">partial_match_not_match_df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">partial_match_not_match_df</span>


<span class="nd">@catch_and_print</span>
<span class="k">def</span> <span class="nf">process_duplicates</span><span class="p">(</span> <span class="n">df</span><span class="p">,</span> <span class="n">drop_duplicates_condition</span><span class="p">):</span>
    <span class="c1">#字段去重</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">drop_duplicates_condition</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span> <span class="ow">and</span> <span class="n">drop_duplicates_condition</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>

        <span class="n">drop_columns</span> <span class="o">=</span> <span class="n">drop_duplicates_condition</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
        <span class="n">lack_column_list</span> <span class="o">=</span> <span class="n">find_lack_columns</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">drop_columns</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span> <span class="o">=</span> <span class="n">drop_columns</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df</span> 

<span class="nd">@catch_and_print</span>
<span class="k">def</span> <span class="nf">replace_value_func</span><span class="p">(</span><span class="n">complete_header_df_new</span><span class="p">,</span> <span class="n">replace_value_str</span><span class="p">,</span> <span class="n">input_column</span><span class="p">,</span> <span class="n">output_column</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">replace_value_str</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="c1">#统一变成字符型类</span>
        <span class="n">replace_values</span> <span class="o">=</span> <span class="n">replace_value_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">replace_value</span> <span class="ow">in</span> <span class="n">replace_values</span><span class="p">:</span>

            <span class="c1">#获取到需要替换的原始值和替换值</span>
            <span class="n">replace_list</span> <span class="o">=</span> <span class="n">replace_value</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">replace_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="p">:</span>
                <span class="c1">#允许替换前的字段内容包含有冒号,从右开始拆分</span>
                <span class="n">replace_original</span> <span class="o">=</span> <span class="n">replace_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">replace_result</span> <span class="o">=</span> <span class="n">replace_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">replace_original</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="n">replace_result</span> <span class="o">=</span> <span class="n">replace_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

            <span class="c1">#如果原始内容非空 并且 需要替换成单纯的其他字符串</span>
            <span class="k">if</span> <span class="n">replace_original</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="s1">&#39;regex(&#39;</span> <span class="o">!=</span> <span class="n">replace_original</span><span class="p">[:</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="p">:</span>  <span class="c1">#支持regex替换</span>
                <span class="n">complete_header_df_new</span><span class="p">[</span><span class="n">output_column</span><span class="p">]</span> <span class="o">=</span> <span class="n">complete_header_df_new</span><span class="p">[</span><span class="n">output_column</span><span class="p">]</span>\
                        <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">replace_original</span><span class="p">,</span><span class="n">replace_result</span><span class="p">,</span><span class="n">regex</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">replace_original</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="s1">&#39;regex(&#39;</span> <span class="o">==</span> <span class="n">replace_original</span><span class="p">[:</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">replace_original</span> <span class="o">=</span> <span class="n">replace_original</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

                <span class="n">complete_header_df_new</span><span class="p">[</span><span class="n">output_column</span><span class="p">]</span> <span class="o">=</span> <span class="n">complete_header_df_new</span><span class="p">[</span><span class="n">output_column</span><span class="p">]</span>\
                        <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">replace_original</span><span class="p">,</span><span class="n">replace_result</span><span class="p">,</span><span class="n">case</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">complete_header_df_new</span><span class="p">[</span><span class="n">output_column</span><span class="p">]</span> <span class="o">=</span> <span class="n">complete_header_df_new</span><span class="p">[</span><span class="n">output_column</span><span class="p">]</span>\
                        <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">replace_original</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">))</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1">#如果原始内容为空，即特别需要填充空值,且不能用series.str</span>
                <span class="n">complete_header_df_new</span><span class="p">[</span><span class="n">output_column</span><span class="p">]</span> <span class="o">=</span> <span class="n">complete_header_df_new</span><span class="p">[</span><span class="n">output_column</span><span class="p">]</span>\
                        <span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">replace_result</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">replace_result</span><span class="p">,</span><span class="n">regex</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">complete_header_df_new</span>


<span class="nd">@catch_and_print</span>
<span class="k">def</span> <span class="nf">fillna_value_func</span><span class="p">(</span><span class="n">complete_header_df</span><span class="p">,</span> <span class="n">complete_header_df_new</span><span class="p">,</span> <span class="n">fillna_value_str</span><span class="p">,</span> <span class="n">output_column</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">fillna_value_str</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="p">:</span>
        <span class="c1">#如果不是用别的字段做填充</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_df_column</span><span class="p">(</span><span class="n">fillna_value_str</span><span class="p">):</span>
            <span class="n">complete_header_df_new</span><span class="p">[</span><span class="n">output_column</span><span class="p">]</span> <span class="o">=</span> <span class="n">complete_header_df_new</span><span class="p">[</span><span class="n">output_column</span><span class="p">]</span>\
                                <span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">fillna_value_str</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">fillna_value_str</span><span class="p">)</span>
        <span class="c1">#如果是属于表格的字段作为填充</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="n">fillna_value_str_strip</span> <span class="o">=</span> <span class="n">fillna_value_str</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">)</span>
            <span class="c1">#注意&quot; 在前面整个字段可能已经被转成string格式，不能单纯通过fillna的方式填充空值,</span>
            <span class="c1">#而replace的方式又无法把其他字段值作为入参</span>
            <span class="k">if</span> <span class="n">fillna_value_str_strip</span> <span class="ow">in</span> <span class="n">complete_header_df_new</span><span class="o">.</span><span class="n">columns</span> <span class="p">:</span>
                <span class="n">complete_header_df_new</span><span class="p">[</span><span class="n">output_column</span><span class="p">]</span> <span class="o">=</span> <span class="n">complete_header_df</span><span class="p">[</span><span class="n">output_column</span><span class="p">]</span>\
                <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">complete_header_df_new</span><span class="p">[</span><span class="n">fillna_value_str_strip</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>  <span class="c1">#想填充的可能是来自旧complete_header_df的字段</span>
                    <span class="n">complete_header_df_new</span><span class="p">[</span><span class="n">fillna_value_str_strip</span><span class="p">]</span> <span class="o">=</span> <span class="n">complete_header_df</span><span class="p">[</span><span class="n">fillna_value_str_strip</span><span class="p">]</span>

                    <span class="n">complete_header_df_new</span><span class="p">[</span><span class="n">output_column</span><span class="p">]</span> <span class="o">=</span> <span class="n">complete_header_df_new</span><span class="p">[</span><span class="n">output_column</span><span class="p">]</span>\
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">complete_header_df_new</span><span class="p">[</span><span class="n">fillna_value_str_strip</span><span class="p">])</span>
                                        
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="n">enter_exit</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fillna error: Column &#39;</span><span class="si">{</span><span class="n">fillna_value_str_strip</span><span class="si">}</span><span class="s2">&#39; doesn&#39;t exist!&quot;</span><span class="p">)</span>

                <span class="n">complete_header_df_new</span> <span class="o">=</span> <span class="n">complete_header_df_new</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">fillna_value_str_strip</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">complete_header_df_new</span>


<span class="nd">@catch_and_print</span>
<span class="k">def</span> <span class="nf">sort_value_func</span><span class="p">(</span><span class="n">complete_header_df_new</span><span class="p">,</span> <span class="n">sort_column_list</span><span class="p">,</span><span class="n">sort_column_order_list</span><span class="p">):</span>
    <span class="c1">#通过数字来排列数字</span>
    <span class="n">order_list</span> <span class="o">=</span> <span class="p">[</span> <span class="p">]</span>
    <span class="k">for</span> <span class="n">column</span><span class="p">,</span><span class="n">order</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">sort_column_list</span><span class="p">,</span><span class="n">sort_column_order_list</span><span class="p">):</span>
        <span class="n">order_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">column</span><span class="p">,</span> <span class="n">order</span><span class="p">))</span>

    <span class="n">order_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">order_list</span><span class="p">,</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

    <span class="n">sort_column_list</span> <span class="o">=</span> <span class="p">[</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">order_list</span> <span class="p">]</span>
    <span class="n">ascending_list</span> <span class="o">=</span> <span class="p">[</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">False</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">order_list</span> <span class="p">]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">complete_header_df_new</span> <span class="o">=</span> <span class="n">complete_header_df_new</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">sort_column_list</span><span class="p">,</span><span class="n">ascending</span><span class="o">=</span><span class="n">ascending_list</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Fill&amp;Order:Error when sorting the values&#39;</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">complete_header_df_new</span>


<span class="nd">@catch_and_print</span>
<span class="k">def</span> <span class="nf">check_mapping_duplicates</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">target_cn_columns</span><span class="p">,</span> <span class="n">table_stem</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
    <span class="c1">#检查映射后是否出现重复字段,  返回需要保留的映射字段即可</span>
    <span class="n">used_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">target_cn_columns</span><span class="p">]</span>

    <span class="c1"># 检查有没有出现重复字段</span>
    <span class="n">count_duplicate</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">used_cols</span><span class="p">)</span><span class="o">.</span><span class="n">most_common</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">count_duplicate</span> <span class="ow">and</span> <span class="n">count_duplicate</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">enter_exit</span><span class="p">(</span><span class="s1">&#39;Table &quot;</span><span class="si">{}</span><span class="s1">&quot; has </span><span class="si">{}</span><span class="s1"> original fields can be mapped to target field &quot;</span><span class="si">{}</span><span class="s1">&quot; that leads to duplication!&#39;</span>
                   <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table_stem</span><span class="p">,</span> <span class="n">count_duplicate</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">count_duplicate</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>

    <span class="k">return</span> <span class="n">df</span> 

<span class="nd">@catch_and_print</span>
<span class="k">def</span> <span class="nf">get_replace_dict</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">replace_dict</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">]</span>
        <span class="n">replace_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([[</span><span class="n">y</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">split_colon</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">replace_dict</span><span class="p">])</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">replace_dict</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">return</span> <span class="n">replace_dict</span>


<span class="nd">@catch_and_print</span>
<span class="k">def</span> <span class="nf">get_save_name</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span><span class="n">config_file_dir</span><span class="p">,</span> <span class="n">min_max_date_range</span><span class="p">):</span>

    <span class="c1">#获取config后面的一截用来做output文件的部分名称</span>
    <span class="n">save_name</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;[_\-]&#39;</span><span class="p">,</span><span class="n">config_file_dir</span><span class="p">,</span><span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="n">min_max_date_range</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">save_name</span> <span class="o">=</span> <span class="n">save_name</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span>  <span class="n">min_max_date_range</span>

    <span class="n">save_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">save_name</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">save_name</span>

<span class="nd">@catch_and_print</span>
<span class="k">def</span> <span class="nf">get_save_sheet_name</span><span class="p">(</span><span class="n">config_table_name</span><span class="p">):</span>

    <span class="n">sheet_name</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">pattern</span><span class="o">=</span><span class="s1">&#39;(.*)(\.xlsx|\.csv|.xls)&#39;</span><span class="p">,</span> <span class="n">repl</span><span class="o">=</span><span class="s1">&#39;\g&lt;1&gt;&#39;</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="n">config_table_name</span><span class="p">)</span>
    <span class="n">sheet_name</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;[_\-]&#39;</span><span class="p">,</span><span class="n">sheet_name</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1">#重复符号换成一个</span>
    <span class="n">sheet_name</span> <span class="o">=</span> <span class="n">replace_multi_symbol</span><span class="p">(</span><span class="n">sheet_name</span><span class="p">,</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>

    <span class="n">sheet_name</span> <span class="o">=</span> <span class="n">strip_puntuations</span><span class="p">(</span><span class="n">sheet_name</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">sheet_name</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">sheet_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;result</span><span class="si">{</span><span class="n">counter</span><span class="si">}</span><span class="s1">&#39;</span>

    <span class="k">return</span>  <span class="n">sheet_name</span>


<span class="nd">@catch_and_print</span>
<span class="k">def</span> <span class="nf">save_results</span><span class="p">(</span><span class="n">save_name</span><span class="p">,</span> <span class="n">result_df_list</span><span class="p">,</span> <span class="n">sheet_name_list</span><span class="p">,</span>
                 <span class="n">checking_result_list</span><span class="p">,</span> <span class="n">checking_result_sheet_names</span><span class="p">,</span> <span class="n">output_file_type</span><span class="p">):</span>
    
    <span class="c1">#确保output目录存在，否则创建output目录</span>
    <span class="n">check_create_new_folder</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">save_name</span><span class="si">}</span><span class="s1">.xlsx&#39;</span><span class="p">)</span>

        <span class="c1">#CSV文档只针对单个输出结果，多个输出结果的话统一用excel保存</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">output_file_type</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span> <span class="ow">and</span> <span class="n">output_file_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;csv&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result_df_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">:</span>
            <span class="n">save_csv</span><span class="p">(</span><span class="n">result_df_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">save_name</span><span class="si">}</span><span class="s1">.csv&#39;</span> <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1">#如果有多个结果，需要分开写入CSV</span>
            <span class="k">for</span> <span class="n">result_df</span><span class="p">,</span><span class="n">sheet_name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">result_df_list</span><span class="p">,</span> <span class="n">sheet_name_list</span><span class="p">):</span>
                <span class="n">save_csv</span><span class="p">(</span><span class="n">result_df</span><span class="p">,</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">save_name</span><span class="si">}</span><span class="s1">(</span><span class="si">{</span><span class="n">sheet_name</span><span class="si">}</span><span class="s1">).csv&#39;</span> <span class="p">)</span>

    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">result_df_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">result_df_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">100</span> <span class="o">*</span> <span class="mi">10000</span> <span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The total number of rows exceeds 1 million, result will be saved in CSV format.&#39;</span><span class="p">)</span>
        <span class="n">save_csv</span><span class="p">(</span><span class="n">result_df</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">save_name</span><span class="si">}</span><span class="s1">.csv&#39;</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">write_format_columns</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">save_name</span><span class="si">}</span><span class="s1">.xlsx&#39;</span><span class="p">,</span><span class="n">result_df_list</span><span class="p">,</span> <span class="n">sheet_name_list</span><span class="p">,</span> <span class="n">min_column_width</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

    <span class="c1">#写入检查数据</span>
    <span class="k">if</span> <span class="n">checking_result_list</span><span class="p">:</span>
        <span class="n">path_stem</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">save_name</span><span class="si">}</span><span class="s1">.xlsx&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">stem</span>
        <span class="n">write_format_columns</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;.</span><span class="se">\\</span><span class="s1">result_checking&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Checking results-</span><span class="si">{</span><span class="n">path_stem</span><span class="si">}</span><span class="s1">.xlsx&#39;</span><span class="p">),</span>
                             <span class="n">checking_result_list</span><span class="p">,</span> <span class="n">checking_result_sheet_names</span><span class="p">,</span> <span class="n">min_column_width</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
            

<div class="viewcode-block" id="split_colon"><a class="viewcode-back" href="../../common_utils_data.html#common_utils_data.data_handle_func.split_colon">[文档]</a><span class="k">def</span> <span class="nf">split_colon</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
    <span class="n">lst</span> <span class="o">=</span> <span class="p">[</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;：&#39;</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>  <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="p">]</span>
    <span class="k">return</span> <span class="n">lst</span></div>

    
<div class="viewcode-block" id="process_join_table"><a class="viewcode-back" href="../../common_utils_data.html#common_utils_data.data_handle_func.process_join_table">[文档]</a><span class="k">def</span> <span class="nf">process_join_table</span><span class="p">(</span><span class="n">join_table_df</span><span class="p">,</span> <span class="n">join_columns</span><span class="p">,</span> <span class="n">target_columns</span><span class="p">,</span><span class="n">filter_condition</span><span class="p">,</span><span class="n">sort_order</span><span class="p">,</span> <span class="n">join_table_name</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
    <span class="c1">#防止里面有重复字段</span>
    <span class="n">join_table_df</span> <span class="o">=</span> <span class="n">remove_duplicate_columns</span><span class="p">(</span><span class="n">join_table_df</span><span class="p">)</span>

    <span class="c1"># 获取过滤条件后的关联表</span>
    <span class="k">if</span> <span class="n">filter_condition</span>  <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">join_table_df</span> <span class="o">=</span> <span class="n">get_filter_condition_match</span><span class="p">(</span><span class="n">join_table_df</span><span class="p">,</span> <span class="n">filter_condition</span><span class="p">)</span>

    <span class="c1">#定位join_table_df中所有需要的字段.不需要的字段删掉</span>
    <span class="n">temp_used_cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">join_columns</span> <span class="o">+</span> <span class="n">target_columns</span><span class="p">))</span>
    <span class="n">join_table_df</span> <span class="o">=</span> <span class="n">join_table_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">temp_used_cols</span><span class="p">]</span>

    <span class="c1"># 将所有关联列转成string格式, 这里截取了固定的字段</span>
    <span class="c1">#需要对关联的所有字段清楚掉空值，否则如果匹配表填的有问题 会出现匹配错误</span>
    <span class="n">join_table_df</span> <span class="o">=</span> <span class="n">join_table_df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> 
        <span class="n">x</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;NaN&#39;</span><span class="p">))</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">join_columns</span> <span class="k">else</span> <span class="n">x</span> <span class="p">)</span>

    <span class="n">join_table_df</span> <span class="o">=</span> <span class="n">join_table_df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">join_columns</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;any&#39;</span><span class="p">)</span>

    <span class="c1">#剩下如果是空 直接返回空匹配表</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">join_table_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">sort_order</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">join_table_df</span> <span class="o">=</span> <span class="n">process_sort_order</span><span class="p">(</span><span class="n">join_table_df</span><span class="p">,</span> <span class="n">join_columns</span><span class="p">,</span> <span class="n">sort_order</span><span class="p">)</span>

        <span class="c1">#如果不是用原始表做关联表的话，关联之前必须做去重，避免笛卡尔积现象</span>
        <span class="k">if</span>  <span class="n">join_table_name</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">join_table_df</span> <span class="o">=</span> <span class="n">join_table_df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">join_columns</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">join_table_df</span></div>

<div class="viewcode-block" id="process_match_complete_table"><a class="viewcode-back" href="../../common_utils_data.html#common_utils_data.data_handle_func.process_match_complete_table">[文档]</a><span class="k">def</span> <span class="nf">process_match_complete_table</span><span class="p">(</span><span class="n">complete_header_df</span><span class="p">,</span><span class="n">source_columns</span><span class="p">,</span> <span class="n">target_columns</span> <span class="p">,</span> <span class="n">join_columns</span><span class="p">,</span> <span class="n">join_table_name</span><span class="p">):</span>
    <span class="c1">#转成str</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">source_columns</span><span class="p">:</span>
        <span class="n">complete_header_df</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">complete_header_df</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="c1">#如果原始表格包含了需要获取到的字段，删掉</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">target_columns</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">t</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">source_columns</span> <span class="ow">and</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">complete_header_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">complete_header_df</span> <span class="o">=</span> <span class="n">complete_header_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">target_columns</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">complete_header_df</span></div>

<div class="viewcode-block" id="check_only_one_match_column"><a class="viewcode-back" href="../../common_utils_data.html#common_utils_data.data_handle_func.check_only_one_match_column">[文档]</a><span class="k">def</span> <span class="nf">check_only_one_match_column</span><span class="p">(</span><span class="n">join_table_df</span><span class="p">,</span> <span class="n">join_columns</span><span class="p">,</span> <span class="n">target_columns</span> <span class="p">):</span>
    <span class="n">only_one_match_column</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">join_columns</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_columns</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">join_columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">target_columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">only_one_match_column</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">join_table_df</span><span class="p">[</span><span class="s1">&#39;additional_temp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">join_table_df</span><span class="p">[</span><span class="n">target_columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">join_columns</span> <span class="o">=</span> <span class="n">join_columns</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;additional_temp&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">join_columns</span> <span class="o">=</span> <span class="n">join_columns</span> <span class="o">+</span> <span class="p">[</span><span class="n">target_columns</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">join_table_df</span><span class="p">,</span> <span class="n">only_one_match_column</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; 版权所有 2022, TracyTang.</p>
  </div>

  利用 <a href="https://www.sphinx-doc.org/">Sphinx</a> 构建，使用的 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">主题</a>
    由 <a href="https://readthedocs.org">Read the Docs</a> 开发.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>